<!doctype html><html><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Integrating Elasticsearch 7 to Django project - Shivamani Patil</title><meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Adding search ability to django using Elasticsearch"><meta property="og:image" content><meta property="og:title" content="Integrating Elasticsearch 7 to Django project"><meta property="og:description" content="Adding search ability to django using Elasticsearch"><meta property="og:type" content="article"><meta property="og:url" content="https://shivamanipatil.github.io/posts/@shivamanipatil10/integrating-elasticsearch-7-to-django-project-c3812de78246/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-18T17:09:05+00:00"><meta property="article:modified_time" content="2019-12-18T17:09:05+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Integrating Elasticsearch 7 to Django project"><meta name=twitter:description content="Adding search ability to django using Elasticsearch"><script src=https://shivamanipatil.github.io/js/feather.min.js></script><link href=https://shivamanipatil.github.io/css/fonts.b685ac6f654695232de7b82a9143a46f9e049c8e3af3a21d9737b01f4be211d1.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://shivamanipatil.github.io/css/main.2f9b5946627215dc1ae7fa5f82bfc9cfcab000329136befeea5733f21e77d68f.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://shivamanipatil.github.io/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css media="(prefers-color-scheme: dark)"><script async src="https://www.googletagmanager.com/gtag/js?id=G-44FM66QXX5"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-44FM66QXX5")</script></head><body><div class=content><header><div class=main><a href=https://shivamanipatil.github.io/>Shivamani Patil</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/open-source>Open Source</a>
<a href=/about>About</a></nav></header><main><article><div class=title><h1 class=title>Integrating Elasticsearch 7 to Django project</h1><div class=meta>Posted on Dec 18, 2019</div></div><section class=body><p>I had to migrate the Elasticsearch 2.x using django-haystack to latest Elasticsearch 7.5.0 for a project. Here the way I did it. You can also follow if you wish to use Elasticsearch for your django project. I will be using Django 2.1.5.</p><p>Haystack is great open-source package that provides modular search for Django.Unfortunately it doesn’t support recent versions of Elasticsearch. So for migration to latest version of Elasticsearch we need to remove django-haystack package. Which can done using :</p><p><code>pip unistall django-haystack</code></p><p>Packages we need are Elasticsearch-DSL and Django Elasticsearch DSL:</p><p>1)<strong>Elasticsearch-DSL</strong> : This is a high level library around official low-level client(elasticsearch-py).</p><p>2)<strong>Django-Elasticsearch-DSL</strong> : This allows easy integration of elasticsearch- dsl-py with django.</p><h3 id=installing-and-running-elasticsearch-server-on-machineserver>Installing and running Elasticsearch server on machine/server :</h3><p>For debian based machines like Ubuntu, Debian etc:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>wget [https:<span style=color:#f92672>//</span>artifacts<span style=color:#f92672>.</span>elastic<span style=color:#f92672>.</span>co<span style=color:#f92672>/</span>downloads<span style=color:#f92672>/</span>elasticsearch<span style=color:#f92672>/</span>elasticsearch<span style=color:#f92672>-</span><span style=color:#ae81ff>7.5</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span>amd64<span style=color:#f92672>.</span>deb](https:<span style=color:#f92672>//</span>artifacts<span style=color:#f92672>.</span>elastic<span style=color:#f92672>.</span>co<span style=color:#f92672>/</span>downloads<span style=color:#f92672>/</span>elasticsearch<span style=color:#f92672>/</span>elasticsearch<span style=color:#f92672>-</span><span style=color:#ae81ff>7.5</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span>amd64<span style=color:#f92672>.</span>deb)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wget [https:<span style=color:#f92672>//</span>artifacts<span style=color:#f92672>.</span>elastic<span style=color:#f92672>.</span>co<span style=color:#f92672>/</span>downloads<span style=color:#f92672>/</span>elasticsearch<span style=color:#f92672>/</span>elasticsearch<span style=color:#f92672>-</span><span style=color:#ae81ff>7.5</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span>amd64<span style=color:#f92672>.</span>deb<span style=color:#f92672>.</span>sha512](https:<span style=color:#f92672>//</span>artifacts<span style=color:#f92672>.</span>elastic<span style=color:#f92672>.</span>co<span style=color:#f92672>/</span>downloads<span style=color:#f92672>/</span>elasticsearch<span style=color:#f92672>/</span>elasticsearch<span style=color:#f92672>-</span><span style=color:#ae81ff>7.5</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span>amd64<span style=color:#f92672>.</span>deb<span style=color:#f92672>.</span>sha512)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>shasum <span style=color:#f92672>-</span>a <span style=color:#ae81ff>512</span> <span style=color:#f92672>-</span>c elasticsearch<span style=color:#f92672>-</span><span style=color:#ae81ff>7.5</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span>amd64<span style=color:#f92672>.</span>deb<span style=color:#f92672>.</span>sha512sudo 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dpkg <span style=color:#f92672>-</span>i elasticsearch<span style=color:#f92672>-</span><span style=color:#ae81ff>7.5</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0</span><span style=color:#f92672>-</span>amd64<span style=color:#f92672>.</span>deb
</span></span></code></pre></div><p>To start Elasticsearch automatically when system boots up run following:</p><p><code>sudo /bin/systemctl daemon-reload sudo /bin/systemctl enable elasticsearch.service</code></p><p>To start elasticsearch service on systemd</p><p><code>sudo systemctl start elasticsearch.service</code></p><p>To stop elasticsearch service on systemd</p><p><code>sudo systemctl stop elasticsearch.service</code></p><p>To get status of elasticsearch service on systemd</p><p><code>systemctl status elasticsearch.service</code></p><p>Also to check if Elasticsearch service is working you can look localhost:9200/ in your browser. For installation guide for other os refer <a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html>https://www.elastic.co/guide/en/elasticsearch/reference/current/install-elasticsearch.html</a>.</p><h3 id=installing-django-elasticsearch-dsl-indjango>Installing Django-Elasticsearch-DSL in django:</h3><p>First install Django-Elasticsearch-DSL for django.</p><p><code>pip install django-elasticsearch-dsl</code></p><p>Remember for Elasticsearch 7.0 and later, use the major version 7 (7.x.y) of this library. Doing <em>pip list</em> shows.</p><p><img src=/piplist.png alt></p><p>Add this snippet to django setting:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ELASTICSEARCH_DSL={  
</span></span><span style=display:flex><span>    &#39;default&#39;: {  
</span></span><span style=display:flex><span>        &#39;hosts&#39;: &#39;localhost:9200&#39;  
</span></span><span style=display:flex><span>    },  
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>This tells Django where our Elasticsearch service is located.</p><h3 id=creating-documentspy>Creating documents.py:</h3><p>I had to implement searching for App and Tag models for ‘apps’ app of a django project. So following code snippets will be related to it. But you can follow same procedure for your project.</p><p>To use App and Tag models with Elasticsearch we need to subclass <em>django_elasticsearch_dsl.Document</em> and create class Index inside it to define indices and then register it the class using <em>registry.register_document</em> decorator. This Document subclasses are defined in documents.py in ‘apps’ directory.</p><p>Create documents.py in your app directory and include this imports:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>from django_elasticsearch_dsl import Document, fields  
</span></span><span style=display:flex><span>from django_elasticsearch_dsl.registries import registry  
</span></span><span style=display:flex><span>from .models import App, Tag
</span></span></code></pre></div><p>For App model we will be searching apps using name, title, description and abstract which are fields of App model. Add this to documents.py.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>@registry.register_document 
</span></span><span style=display:flex><span>class AppDocument(Document):  
</span></span><span style=display:flex><span>    class Index:  
</span></span><span style=display:flex><span>        name = &#39;apps&#39;  
</span></span><span style=display:flex><span>        settings = {&#39;number_of_shards&#39;: 1,  
</span></span><span style=display:flex><span>                    &#39;number_of_replicas&#39;: 0}  
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    description = fields.TextField(attr = &#39;get_description&#39;)  
</span></span><span style=display:flex><span>    class Django:  
</span></span><span style=display:flex><span>        model = App  
</span></span><span style=display:flex><span>        fields = [  
</span></span><span style=display:flex><span>            &#39;name&#39;,  
</span></span><span style=display:flex><span>            &#39;title&#39;,  
</span></span><span style=display:flex><span>            &#39;website&#39;,  
</span></span><span style=display:flex><span>            &#39;abstract&#39;,  
</span></span><span style=display:flex><span>        ]
</span></span></code></pre></div><p>name = ‘apps’ refers to name of index and fields refers to fields with which we will be searching and are present in your model. Also model = App which refers to the model for which we are building index.Shards and replicas can be set as per your needs.</p><p>Here description is <em>a markdownx</em>() field in App model which was giving error when included in fields section so to include description field for search I had to write a function(get_description) in App model class to return description field from App model. But this is just specific to mardownx() field.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>def get_description(self):  
</span></span><span style=display:flex><span>        return self.description
</span></span></code></pre></div><p>And for Tag model we will be searching tags using name and identity which can be done using the same procedure.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>@registry.register_document
</span></span><span style=display:flex><span>class TagDocument(Document):  
</span></span><span style=display:flex><span>    class Index:  
</span></span><span style=display:flex><span>        name = &#39;tags&#39;  
</span></span><span style=display:flex><span>        settings = {&#39;number_of_shards&#39;: 1,  
</span></span><span style=display:flex><span>                    &#39;number_of_replicas&#39;: 0}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class Django:  
</span></span><span style=display:flex><span>        model = Tag  
</span></span><span style=display:flex><span>        fields = [  
</span></span><span style=display:flex><span>            &#39;name&#39;,  
</span></span><span style=display:flex><span>            &#39;identity&#39;,  
</span></span><span style=display:flex><span>              
</span></span><span style=display:flex><span>        ]
</span></span></code></pre></div><p>After creating documents.py we build the indices.</p><p><strong>To create Elasticsearch indices and mappings use following command:</strong></p><p><code>python manage.py search_index --rebuild</code></p><p>Once this is done existings objects will mapped as well as when new objects(here apps/tags) are added to the database they will be automatically mapped with Elasticsearch indices.</p><h3 id=displaying-searchresults>Displaying search results</h3><p>Now we need to display search results. Create a search app for your project. In this project it was already created. We need to modify views.py in search app for handling the search request and render it for our template.</p><p>First import AppDocument and TagDocument from documents.py in views.py of search app:</p><p><code>from apps.documents import AppDocument, TagDocument</code></p><p>Inside search(request) method inside views.py of search app:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>query = request.GET.get(&#39;q&#39;, &#39;&#39;)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sqs_app = AppDocument.search().query(&#34;multi_match&#34;, query = query  
</span></span><span style=display:flex><span>     , fields = [&#34;name&#34;, &#34;title&#34;, &#34;abstract&#34;, &#34;description&#34;])  
</span></span><span style=display:flex><span>sqs_tag = TagDocument.search().query(&#34;match&#34;, name = query)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app = sqs_app.to_queryset()  
</span></span><span style=display:flex><span>tag = sqs_tag.to_queryset()
</span></span></code></pre></div><p>Here query is actual query for searching. For App we do multi-match query as there are 4 fields to be searched and for tag we do just use name field query. sqs_app and sqs_tag are search querysets of results obtained. Existing html template expected django query set. So to return this query set as django query set I used to_queryset() method . Then return the queryset to your template.</p><p>Thank you for reading :)</p></section><div class=post-tags></div></article></main><footer><hr><a class=soc href=https://github.com/shivamanipatil title=GitHub><i data-feather=github></i></a>|<a class=soc href=https://twitter.com/ShivamaniPatil_ title=Twitter><i data-feather=twitter></i></a>|⚡️
2023 <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></footer><script>feather.replace()</script></div></body></html>